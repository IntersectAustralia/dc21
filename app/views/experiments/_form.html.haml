
= form_for [@facility, @experiment] do |f|
  - if @experiment.new_record?
    %h2 New Experiment
  - else
    %h2 Edit Experiment

  .rowform
    .formerror= render "shared/error_messages", :target => @experiment

  .control-group
    = f.label :parent_experiment_id, "Parent", class: "control-label"
    .controls
      = required
      %span.input
        = f.collection_select :parent_experiment_id, @facility.experiments_excluding_me(@experiment), :id, :name_with_prefix, {:include_blank => "Facility - #{@facility.name}"}

  .control-group
    = f.label :name, "Name", class: "control-label"
    .controls
      = required
      = f.text_field :name
  
  .control-group
    = f.label :description, "Description", class: "control-label"
    .controls
      = f.text_area :description

  .control-group
    = f.label :start_date, "Start date", class: "control-label"
    .controls
      = required
      = f.text_field :start_date, :datepicker => true

  .control-group
    = f.label :end_date, "End date", class: "control-label"
    .controls
      = f.text_field :end_date, :datepicker => true

  .control-group
    = f.label :subject, "Subject", class: "control-label"
    .controls
      = required
      = f.text_field :subject

  .control-group
    = f.label :access_rights, class: "control-label"
    .controls
      = required
      %span.input
        = f.select :access_rights, options_for_select(access_rights, @experiment.access_rights), {:include_blank => "Please select"}

  .control-group
    = label_tag :for_code_select_1, "FOR codes", class: "control-label"
    .controls
      %span.input
        = select_tag :for_code, options_for_select(for_codes), :prompt => "Please select", :id => :for_code_select_1
      #second_level
        %span.input
          = select_tag :for_code_level2, options_for_select([]), :prompt => "Please select", :id => :for_code_select_2
      #third_level
        %span.input
          = select_tag :for_code_level3, options_for_select([]), :prompt => "Please select", :id => :for_code_select_3
      .for.add
        = link_to "Add", "#", :id => :add_for_code_link, :class => "whitebutton"

      #selected_for_codes
        %ul#for_codes_list
          - @experiment.experiment_for_codes.each_with_index do |code, index|
            %li
              = code.name
              = hidden_field_tag "for_codes[#{index}][url]", code.url
              = hidden_field_tag "for_codes[#{index}][name]", code.name
              = link_to "Delete", "#", :class => "delete_for_code"
  .form-actions
    .actions-pre
      .cancelbutton
        %span
        = link_to 'Cancel', (@experiment.new_record? ? @facility : facility_experiment_path(@facility, @experiment)), :class => "cancelbutton"
    .actions
      = f.submit 'Save Experiment', :class => ""

:javascript
  $(function(){
    $('#second_level').hide();
    $('#third_level').hide();

    $('select#for_code_select_1').change(function(e){
      var new_value = $(this).val();
      if (new_value != "")
      {
        $.getJSON('/for_codes/second_level',{top_level : $(this).val()},function(result){
          $('select#for_code_select_2').html("<option value=''>Please select</option>");
          $.each(result,function(item, value){
            $("<option value='" + value[1] + "'>" + value[0] + "</option>").appendTo("select#for_code_select_2");
          });
        });
        $('#second_level').show();
      }
      else
      {
        $('select#for_code_select_2').html("<option value=''>Please select</option>");
        $('#second_level').hide();
      }
      $('select#for_code_select_3').html("<option value=''>Please select</option>");
      $('#third_level').hide();
    });

    $('select#for_code_select_2').change(function(e){
      var new_value = $(this).val();
      if (new_value != "")
      {
        $.getJSON('/for_codes/third_level',{second_level : $(this).val()},function(result){
          $('select#for_code_select_3').html("<option value=''>Please select</option>");
          $.each(result,function(item, value){
            $("<option value='" + value[1] + "'>" + value[0] + "</option>").appendTo("select#for_code_select_3");
          });
        });
        $('#third_level').show();
      }
      else
      {
        $('select#for_code_select_3').html("<option value=''>Please select</option>");
        $('#third_level').hide();
      }
    });

    $('#add_for_code_link').live('click', function(){
      var for_code_1 = $('#for_code_select_1').val();
      var for_code_2 = $('#for_code_select_2').val();
      var for_code_3 = $('#for_code_select_3').val();
      var for_code = "";
      var for_code_text = "";
      if (for_code_3 != "")
      {
        for_code = for_code_3;
        for_code_text = $('#for_code_select_3 option:selected').text();
      }
      else if (for_code_2 != "")
      {
        for_code = for_code_2;
        for_code_text = $('#for_code_select_2 option:selected').text();
      }
      else if (for_code_1 != "")
      {
        for_code = for_code_1;
        for_code_text = $('#for_code_select_1 option:selected').text();
      }
      if (for_code != "")
      {
        var new_element = "<li>";
        var new_id  = new Date().getTime();
        new_element += for_code_text;
        new_element += "<input type='hidden' name='for_codes[" + new_id + "][url]', value='" + for_code + "'/>";
        new_element += "<input type='hidden' name='for_codes[" + new_id + "][name]', value='" + for_code_text + "'/>";
        new_element += "<a href='#' class='delete_for_code'>Delete</a>";
        new_element += "</li>";
        $('#for_codes_list').append(new_element);

        $('select#for_code_select_1').val("");
        $('select#for_code_select_2').html("<option value=''>Please select</option>");
        $('#second_level').hide();
        $('select#for_code_select_3').html("<option value=''>Please select</option>");
        $('#third_level').hide();
      }

      return false;
    });

    $('.delete_for_code').live('click', function(){
      $(this).parent().remove();
      return false;
    });
  });
